name: Build RHEL7 Toolchain

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

# Cancel previous runs when a new one starts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/rhel7-sysroot

jobs:
  build-toolchain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Build container image
      run: |
        echo "ðŸ—ï¸ Building container image..."
        make docker-build
        
    - name: Build toolchain (this takes 30-60 minutes)
      run: |
        echo "â³ Building toolchain - this will take 30-60 minutes..."
        echo "ðŸ’­ The runner has 4 cores and 16GB RAM, should be sufficient"
        
        timeout 90m make docker-toolchain || {
          echo "âŒ Toolchain build timed out after 90 minutes"
          echo "ðŸ“Š Checking what was built so far..."
          ls -la toolchain-output/ || echo "No output directory found"
          exit 1
        }

    - name: Verify toolchain build
      run: |
        make verify

    - name: Package toolchain
      run: |
        echo "ðŸ“¦ Packaging toolchain for distribution..."
        make package
        
        echo "ðŸ“‹ Package contents:"
        ls -la exported-toolchain/
        
        # Get archive name for later steps
        ARCHIVE_NAME=$(ls exported-toolchain/rhel7-toolchain-*.tar.gz | head -1 | xargs basename)
        echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
        
        echo "ðŸ“Š Archive size:"
        du -h exported-toolchain/$ARCHIVE_NAME

    - name: Create release notes
      run: |
        cat > release-notes.md << 'EOF'
        # RHEL7 Sysroot Toolchain Release
        
        **Automated build from commit:** `${{ github.sha }}`
        **Build date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        **Branch/Tag:** ${{ github.ref_name }}
        
        ## ðŸ“¦ Package Contents
        - `rhel7-toolchain-*.tar.gz` - Complete GCC 8.5.0 + glibc 2.28 toolchain
        - `patchelf-0.18.0-x86_64.tar.gz` - Required by VS Code Remote SSH
        - `install-toolchain.sh` - Automated installation script
        
        ## ðŸš€ Installation
        ```bash
        # Download all files to your RHEL 7 server
        wget https://github.com/${{ github.repository }}/releases/latest/download/rhel7-toolchain-*.tar.gz
        wget https://github.com/${{ github.repository }}/releases/latest/download/patchelf-0.18.0-x86_64.tar.gz  
        wget https://github.com/${{ github.repository }}/releases/latest/download/install-toolchain.sh
        
        # Install (completely offline)
        chmod +x install-toolchain.sh
        ./install-toolchain.sh
        ```
        
        ## âœ… Features
        - **Isolated installation** - Won't affect system GCC or applications
        - **VS Code Remote SSH ready** - Includes patchelf and environment setup
        - **Modern C++17/C17 support** - GCC 8.5.0 with glibc 2.28
        - **Completely offline** - No internet required on target server
        
        ## ðŸ”§ Build Environment
        - Built on: Ubuntu 22.04 (GitHub Actions)
        - Container: CentOS 7 with crosstool-ng 1.26.0
        - Build time: ~45-60 minutes
        - Package size: ~$(du -h exported-toolchain/rhel7-toolchain-*.tar.gz | cut -f1 | head -1)
        
        ---
        *This release was automatically generated by GitHub Actions*
        EOF

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rhel7-toolchain-${{ github.run_number }}
        path: |
          exported-toolchain/
          release-notes.md
        retention-days: 30

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          exported-toolchain/rhel7-toolchain-*.tar.gz
          exported-toolchain/patchelf-0.18.0-x86_64.tar.gz
          exported-toolchain/install-toolchain.sh
        body_path: release-notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const releaseNotes = fs.readFileSync('release-notes.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ”§ Toolchain Build Complete!\n\n${releaseNotes}\n\n**ðŸ“¦ Artifacts:** Available in the workflow run for 30 days.`
          });

  # Optional: Build summary job
  build-summary:
    needs: build-toolchain
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch/Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-toolchain.result }}" == "success" ]; then
          echo "âœ… **Toolchain build:** SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Check the artifacts section for downloadable packages." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Toolchain build:** FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Check the logs** for build errors." >> $GITHUB_STEP_SUMMARY
          echo "â° **Common issues:** Timeout (>90min), insufficient disk space, dependency errors." >> $GITHUB_STEP_SUMMARY
        fi